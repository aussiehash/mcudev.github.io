<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>TREZOR Dev Kits</title>
    <link rel="stylesheet" href="../css/base.css">
  </head>
  <body>
    <header>
      <h1>TREZOR Dev Kits</h1>
    </header>
    <section>
      <h1>Introduction</h1>
      <p>This hobbyist project documents kits that developers can use to explore, develop, test, and debug the open source TREZOR hardware and software.</p>
    </section>
    <section>
      <h1>Warning</h1>
      <p>These kits do NOT produce production TREZOR cryptocurrency hardware wallet devices.</p>
      <p>If you want an official TREZOR hardware wallet, see: <a href="https://shop.trezor.io/" target="_blank">https://shop.trezor.io/</a></p>
      <p>When contrasted to official production hardware, these kits are less safe to use for non-development purposes.</p>
      <p>
        Necessarily, different selections were made for the key security properties of these developer kits vs. production hardware.
        For example, when used as documented here, these kits purposefully leave debug capabilities enabled, and do not apply write protections to bootloader flash memory.
        This is so that developers may repeatedly develop, test, and debug all types of changes.
      </p>
      <p>
        Production hardware irreversibly disables debug capabilities and Device Firmware Upgrade (DFU) mode, and protects key memory areas as part of reducing attack surface and increasing depth of defenses.
        There may be other subtle, yet meaningful, weaknesses as well, depending on your usage and threat model.
      </p>
      <p>USE THESE KITS AT YOUR OWN RISK</p>
    </section>
    <section>
      <h1>Hardware</h1>
      <section>
        <h1>TREZOR v1 Open Source Hardware Reference Documentation</h1>
        <ul>
          <li><a href="https://github.com/trezor/trezor-hw" target="_blank">https://github.com/trezor/trezor-hw</a></li>
          <li><a href="https://raw.githubusercontent.com/trezor/trezor-hw/master/electronics/trezor.bom.txt" target="_blank">BOM</a></li>
          <li><a href="https://raw.githubusercontent.com/trezor/trezor-hw/master/electronics/trezor_v1.1.sch.png" target="_blank">Schematic</a></li>
        </ul>
      </section>
      <section>
        <h1>Kit Contents: v0 (the breadboard version)</h1>
        <ul>
          <li>1 x <a href="http://www.waveshare.com/core405r.htm" target="_blank">Waveshare Core405R Dev Board</a></li>
          <li>1 x ST-LINK V2 STM32 USB Debug Adapter</li>
          <li>1 x 7-pin SPI 128x64 0.96 inch SSD1306 driven OLED Display Module</li>
          <li>2 x 12mm x 12mm x 5mm tactile momentary switches</li>
          <li>1 x half-size solderless breadboard</li>
          <li>1 x USB Cable Type A Plug/Male to Type Mini-B Plug/Male</li>
          <li>Female to male jumper wires with 0.1" header contacts</li>
          <li>Female to female jumper wires with 0.1" header contacts</li>
          <li>22 AWG solid-core copper wire</li>
        </ul>
        <figure>
          <a href="./images/kit.jpg" target="_blank"><img src="./images/kit.jpg" alt="v0"></a>
          <figcaption>Fig H1. - v0</figcaption>
        </figure>
      </section>
      <section>
        <h1>Kit Contents: v1 (the first printed wiring board [PWB] version)</h1>
        <ul>
          <li>1 x <a href="http://www.waveshare.com/core405r.htm" target="_blank">Waveshare Core405R Dev Board</a></li>
          <li>1 x ST-LINK V2 STM32 USB Debug Adapter</li>
          <li>1 x 7-pin SPI 128x64 1.54 inch SSD1309 driven OLED Display Module (Note: The SSD1309 is compatible with the SSD1306. The v0 kit display is interchangeable with this display.)</li>
          <li>1 x PWB (schematic and board files available <a href="https://github.com/mcudev/mcudev.github.io/tree/master/trezor-dev-kit/v1" target="_blank">here</a>)</li>
          <li>2 x 12mm x 12mm x 5mm tactile momentary switches</li>
          <li>1 x USB Cable Type A Plug/Male to Type Mini-B Plug/Male</li>
          <li>1 x 2.54mm Pitch, Single Row, 7 Position, Female/Socket Header (preci-dip 801-87-007-10-001101 works well)</li>
          <li>2 x 2.54mm Pitch, Double Row, 16 Position, Female/Socket Header (preci-dip 803-87-016-10-001101 works well)</li>
          <li>Solder and Soldering Tools</li>
        </ul>
        <figure>
          <a href="./images/pcb-1.jpg" target="_blank"><img src="./images/pcb-1.jpg" alt="Bare PWB (top)"></a>
          <figcaption>Fig H2. - Bare PWB (top)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-2.jpg" target="_blank"><img src="./images/pcb-2.jpg" alt="Bare PWB (bottom)"></a>
          <figcaption>Fig H3. - Bare PWB (bottom)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-3.jpg" target="_blank"><img src="./images/pcb-3.jpg" alt="Assembled PWB (top)"></a>
          <figcaption>Fig H4. - Assembled PWB (top)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-4.jpg" target="_blank"><img src="./images/pcb-4.jpg" alt="Assembled PWB (bottom)"></a>
          <figcaption>Fig H5. - Assembled PWB (bottom)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-5.jpg" target="_blank"><img src="./images/pcb-5.jpg" alt="Front angle view (with large 1.54 inch display)"></a>
          <figcaption>Fig H6. - Front angle view (with large 1.54 inch display)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-6.jpg" target="_blank"><img src="./images/pcb-6.jpg" alt="Side view, PWB and display module stacked on the dev board"></a>
          <figcaption>Fig H7. - Side view, PWB and display module stacked on the dev board</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-7.jpg" target="_blank"><img src="./images/pcb-7.jpg" alt="Installed and running (large 1.54 inch display)"></a>
          <figcaption>Fig H8. - Installed and running (large 1.54 inch display)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-8.jpg" target="_blank"><img src="./images/pcb-8.jpg" alt="Installed and running (regular 0.96 inch display)"></a>
          <figcaption>Fig H9. - Installed and running (regular 0.96 inch display)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-9.jpg" target="_blank"><img src="./images/pcb-9.jpg" alt="0.96 inch SSD1306 driven display and 1.54 inch SSD1309 driven display side-by-side (top)"></a>
          <figcaption>Fig H10. - 0.96 inch SSD1306 driven display and 1.54 inch SSD1309 driven display side-by-side (top)</figcaption>
        </figure>
        <figure>
          <a href="./images/pcb-10.jpg" target="_blank"><img src="./images/pcb-10.jpg" alt="0.96 inch SSD1306 driven display and 1.54 inch SSD1309 driven display side-by-side (bottom)"></a>
          <figcaption>Fig H11. - 0.96 inch SSD1306 driven display and 1.54 inch SSD1309 driven display side-by-side (bottom)</figcaption>
        </figure>
      </section>
      <section>
        <h1>Kit Contents: v2 (the second printed wiring board [PWB] version)</h1>
        <ul>
          <li>1 x <a href="http://www.waveshare.com/core405r.htm" target="_blank">Waveshare Core405R Dev Board</a></li>
          <li>1 x ST-LINK V2 STM32 USB Debug Adapter</li>
          <li>1 x 7-pin SPI 128x64 1.54 inch SSD1309 driven OLED Display Module (Note: The SSD1309 is compatible with the SSD1306. The v0 kit display is interchangeable with this display.)</li>
          <li>1 x PWB (schematic and board files available <a href="https://github.com/mcudev/mcudev.github.io/tree/master/trezor-dev-kit/v2" target="_blank">here</a>)</li>
          <li>2 x 12mm x 12mm x 5mm tactile momentary switches</li>
          <li>1 x USB Cable Type A Plug/Male to Type Mini-B Plug/Male</li>
          <li>1 x 2.54mm Pitch, Single Row, 7 Position, Female/Socket Header (preci-dip 801-87-007-10-001101 works well)</li>
          <li>4 x 2.54mm Pitch, Double Row, 16 Position, Female/Socket Header (preci-dip 803-87-016-10-001101 works well)<br>-OR-<br>2 x 2.54mm Pitch, Double Row, 32 Position, Female/Socket Header (Samtec SSQ-116-03-T-D works well and has long leads for easy testing)</li>
          <li>Solder and Soldering Tools</li>
        </ul>
        <figure>
          <a href="./images/v2-1.jpg" target="_blank"><img src="./images/v2-1.jpg" alt="Bare PWB (top)"></a>
          <figcaption>Fig H12. - Bare PWB (top)</figcaption>
        </figure>
        <figure>
          <a href="./images/v2-2.jpg" target="_blank"><img src="./images/v2-2.jpg" alt="Bare PWB (bottom)"></a>
          <figcaption>Fig H13. - Bare PWB (bottom)</figcaption>
        </figure>
        <figure>
          <a href="./images/v2-3.jpg" target="_blank"><img src="./images/v2-3.jpg" alt="Assembled PWB (top)"></a>
          <figcaption>Fig H14. - Assembled PWB (top)</figcaption>
        </figure>
        <figure>
          <a href="./images/v2-4.jpg" target="_blank"><img src="./images/v2-4.jpg" alt="Assembled PWB (bottom)"></a>
          <figcaption>Fig H15. - Assembled PWB (bottom)</figcaption>
        </figure>
        <figure>
          <a href="./images/v2-5.jpg" target="_blank"><img src="./images/v2-5.jpg" alt="Front angle view (with large 1.54 inch display)"></a>
          <figcaption>Fig H16. - Front angle view (with large 1.54 inch display)</figcaption>
        </figure>
        <figure>
          <a href="./images/v2-6.jpg" target="_blank"><img src="./images/v2-6.jpg" alt="Side view, PWB and display module stacked on the dev board"></a>
          <figcaption>Fig H17. - Side view, PWB and display module stacked on the dev board</figcaption>
        </figure>
        <figure>
          <a href="./images/v2-7.jpg" target="_blank"><img src="./images/v2-7.jpg" alt="Installed and running (large 1.54 inch display)"></a>
          <figcaption>Fig H18. - Installed and running (large 1.54 inch display)</figcaption>
        </figure>
        <figure>
          <a href="./images/v2-8.jpg" target="_blank"><img src="./images/v2-8.jpg" alt="Installed and running (regular 0.96 inch display)"></a>
          <figcaption>Fig H19. - Installed and running (regular 0.96 inch display)</figcaption>
        </figure>
      </section>
      <section>
        <h1>About the Kits</h1>
        <p>
          One key difference between these kits and production hardware is the microcontroller (MCU) used.
          Production hardware uses the STM32F205RET6 MCU and these kits use the STM32F405RGT6 MCU.
          The former is an ARM&reg; Cortex&reg;-M3 and the latter is an ARM&reg; Cortex&reg;-M4.
          The Cortex-M4 architecture is a backwards compatible superset of Cortex-M3. The additional features, like hard float capability, do not matter for this project.
          The STM32F405RGT6 has 1MB of flash memory (vs the 205's 512KB), a core clock frequency adjustable up to 168MHz (including the 205's 120MHz; with matching clock tree), and 128KB of SRAM (same as the 205; the 405 has an additional 64KB of CCMRAM, giving it 192KB of usable RAM).
          The STM32F405RGT6 is pin-to-pin compatible with the STM32F205RET6 and uses the same TRNG (reference: STM32F405xx datasheet section 2.1, and AN4230 section 1.2.1).
        </p>
        <p>The Waveshare Core405R dev board has an 8MHz high-speed external (HSE) crystal (matching the reference hardware), a STM32F405RGT6 MCU, a USB connector, power circuitry, SWD debug interface, boot mode select switch, and all the pins needed, broken out and available for use.</p>
      </section>
      <section>
        <h1>Setup</h1>
        <section>
          <h1>Wiring the Debug Adapter to the Dev Board</h1>
          <p>
            Pay attention to the pinout that is specified on the debug adapter.
            Also, pay attention to the location of the notch on the header housing.
            Note that the white rectangle printed next to pin 5 on the pinout specification in Figure H20 denotes the notch.
          </p>
          <p>Connect the Debug Adapter's SWDIO, SWCLK, and GND pins (any one of the ground pins is sufficient) to the corresponding pins on the Dev Board's SWD connector.</p>
          <figure>
            <a href="./images/debug-adapter.jpg" target="_blank"><img src="./images/debug-adapter.jpg" alt="The Debug Adapter with Pinout Silkscreen"></a>
            <figcaption>Fig H20. - The Debug Adapter with Pinout Silkscreen</figcaption>
          </figure>
          <figure>
            <a href="./images/debug-adapter-connector.jpg" target="_blank"><img src="./images/debug-adapter-connector.jpg" alt="The Debug Adapter Notch"></a>
            <figcaption>Fig H21. - The Debug Adapter Notch</figcaption>
          </figure>
          <figure>
            <a href="./images/swd-connector.jpg" target="_blank"><img src="./images/swd-connector.jpg" alt="The Dev Board SWD Connector"></a>
            <figcaption>Fig H22. - The Dev Board SWD Connector</figcaption>
          </figure>
          <figure>
            <a href="./images/debug-adapter-wired-1.jpg" target="_blank"><img src="./images/debug-adapter-wired-1.jpg" alt="The Debug Adapter Wired - Debug Adapter Side"></a>
            <figcaption>Fig H23. - The Debug Adapter Wired - Debug Adapter Side</figcaption>
          </figure>
          <figure>
            <a href="./images/debug-adapter-wired-2.jpg" target="_blank"><img src="./images/debug-adapter-wired-2.jpg" alt="The Debug Adapter Wired - Dev Board Side"></a>
            <figcaption>Fig H24. - The Debug Adapter Wired - Dev Board Side</figcaption>
          </figure>
          <figure>
            <a href="./images/debug-adapter-wired-3.jpg" target="_blank"><img src="./images/debug-adapter-wired-3.jpg" alt="The Debug Adapter Wired"></a>
            <figcaption>Fig H25. - The Debug Adapter Wired</figcaption>
          </figure>
          <p>Note: Instead of using the JTAG/SWD connector, the debug adapter's SWDIO, SWCLK, and GND pins may also be connected to the dev board's PA13, PA14, and GND pins, respectively.</p>
          <figure>
            <a href="./images/debug-long-headers-1.jpg" target="_blank"><img src="./images/debug-long-headers-1.jpg" alt="The Debug Adapter Wired - Without using the JTAG/SWD Connector"></a>
            <figcaption>Fig H26. - The Debug Adapter Wired - Without using the JTAG/SWD Connector</figcaption>
          </figure>
          <figure>
            <a href="./images/debug-long-headers-2.jpg" target="_blank"><img src="./images/debug-long-headers-2.jpg" alt="The Debug Adapter Wired - Samtec SSQ-116-03-T-D Headers"></a>
            <figcaption>Fig H27. - The Debug Adapter Wired - Samtec SSQ-116-03-T-D Headers</figcaption>
          </figure>
          <figure>
            <a href="./images/debug-long-headers-3.jpg" target="_blank"><img src="./images/debug-long-headers-3.jpg" alt="The Debug Adapter Wired - Using the PA13, PA14, and GND Pins"></a>
            <figcaption>Fig H28. - The Debug Adapter Wired - Using the PA13, PA14, and GND Pins</figcaption>
          </figure>
        </section>
        <section>
          <h1>Setting Dev Board Jumpers and Switches</h1>
          <p>Set the Dev Board jumpers and switches as shown in Figure H29.</p>
          <figure>
            <a href="./images/dev-board-jumpers-switches.jpg" target="_blank"><img src="./images/dev-board-jumpers-switches.jpg" alt="The Dev Board Jumper and Switch Configuration"></a>
            <figcaption>Fig H29. - The Dev Board Jumper and Switch Configuration</figcaption>
          </figure>
        </section>
        <section>
          <h1>Wiring the Dev Board to the Breadboard Display and Switches</h1>
          <p>Use the following table to wire between the dev board and appropriate tie points on your breadboard. The following pictures are also helpful if you don't quite understand.</p>
          <p>Pins on the dev board are documented by the silkscreen on the other side of the board. Pins on the display module are also documented by silkscreen.</p>
          <table>
            <tr><th>Dev Board Pin</th><th>Breadboard Pin</th><th>Alternate Name</th><th>Comment</th></tr>
            <tr><td>PC5</td><td>Button 2</td><td></td><td>Either button pin; connect GND to the other button pin; button is Active-Low</td></tr>
            <tr><td>PA4</td><td>CS</td><td>Chip Select</td><td>Pin 7 on Pictured Display</td></tr>
            <tr><td>PB0</td><td>DC</td><td>Data/Command</td><td>Pin 6 on Pictured Display</td></tr>
            <tr><td>PB1</td><td>RES</td><td>Reset</td><td>Pin 5 on Pictured Display</td></tr>
            <tr><td>PA7</td><td>SDA</td><td>MOSI</td><td>Pin 4 on Pictured Display</td></tr>
            <tr><td>PA5</td><td>SCK</td><td>SCLK</td><td>Pin 3 on Pictured Display</td></tr>
            <tr><td>3.3V</td><td>VDD</td><td>3V3</td><td>Pin 2 on Pictured Display</td></tr>
            <tr><td>GND</td><td>GND</td><td>Ground</td><td>Pin 1 on Pictured Display</td></tr>
            <tr><td>PC2</td><td>Button 1</td><td></td><td>Either button pin; connect GND to the other button pin; button is Active-Low</td></tr>
          </table>
          <figure>
            <a href="./images/dev-board-wiring-1.jpg" target="_blank"><img src="./images/dev-board-wiring-1.jpg" alt="Dev Board Wiring"></a>
            <figcaption>Fig H30. - Dev Board Wiring</figcaption>
          </figure>
          <figure>
            <a href="./images/dev-board-wiring-2.jpg" target="_blank"><img src="./images/dev-board-wiring-2.jpg" alt="Dev Board Wiring"></a>
            <figcaption>Fig H31. - Dev Board Wiring</figcaption>
          </figure>
          <figure>
            <a href="./images/dev-board-wiring-3.jpg" target="_blank"><img src="./images/dev-board-wiring-3.jpg" alt="Dev Board Wiring"></a>
            <figcaption>Fig H32. - Dev Board Wiring</figcaption>
          </figure>
          <figure>
            <a href="./images/dev-board-wiring-4.jpg" target="_blank"><img src="./images/dev-board-wiring-4.jpg" alt="Dev Board Wiring"></a>
            <figcaption>Fig H33. - Dev Board Wiring</figcaption>
          </figure>
          <figure>
            <a href="./images/dev-board-wiring-5.jpg" target="_blank"><img src="./images/dev-board-wiring-5.jpg" alt="Dev Board Wiring"></a>
            <figcaption>Fig H34. - Dev Board Wiring</figcaption>
          </figure>
          <figure>
            <a href="./images/dev-board-wiring-6.jpg" target="_blank"><img src="./images/dev-board-wiring-6.jpg" alt="Dev Board Wiring"></a>
            <figcaption>Fig H35. - Dev Board Wiring</figcaption>
          </figure>
        </section>
      </section>
    </section>
    <section>
      <h1>Software</h1>
      <section>
        <h1>TREZOR v1 Open Source Software Main Repository</h1>
        <ul>
          <li><a href="https://github.com/trezor/trezor-mcu" target="_blank">https://github.com/trezor/trezor-mcu</a></li>
        </ul>
      </section>
      <section>
        <h1>Setup</h1>
        <p>
          This setup process comprises steps to install development and debugging tools on a temporary computer, then build and install a bootloader and firmware on the kit's MCU.<br>
          The following setup process was documented while running an Ubuntu GNOME 17.04 Live CD (Zesty Zapus) as user ubuntu-gnome.
        </p>
        <ol>
          <li>Connect to the Internet</li>
          <li>cd /tmp/</li>
          <li>Install required software packages<br>
            <ul>
              <li>sudo apt-get update</li>
              <li>sudo apt-get -y install git python-pip</li>
              <li>sudo -H pip install ecdsa</li>
              <li>sudo apt-get -y install python-dev cython libusb-1.0-0-dev libudev-dev (note: required for python-trezor testing)</li>
              <li>sudo -H pip install setuptools click trezor (note: required for python-trezor testing)</li>
              <li>sudo apt-get -y install openjdk-8-jdk (note: required for the eclipse GUI)</li>
            </ul>
          </li>
          <li>Download tools<br>
            <ul>
              <li><a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank">GNU ARM Embedded Toolchain</a><br>
                <ul>
                  <li>wget https://developer.arm.com/-/media/Files/downloads/gnu-rm/6-2017q2/gcc-arm-none-eabi-6-2017-q2-update-linux.tar.bz2</li>
                </ul>
              </li>
              <li><a href="https://gnu-mcu-eclipse.github.io/openocd/" target="_blank">OpenOCD</a> (see also <a href="http://openocd.org/doc-release/pdf/openocd.pdf" target="_blank">http://openocd.org/doc-release/pdf/openocd.pdf</a>)<br>
                <ul>
                  <li>wget https://github.com/gnu-mcu-eclipse/openocd/releases/download/gae-0.10.0-20170418/gnuarmeclipse-openocd-debian64-0.10.0-201704182147-dev.tgz</li>
                </ul>
              </li>
              <li><a href="https://www.eclipse.org/downloads/eclipse-packages/" target="_blank">Eclipse IDE for C/C++ Developers</a> (get the latest 64-bit Linux version available; Oxygen or newer)<br>
                <ul>
                  <li>wget http://mirror.math.princeton.edu/pub/eclipse/technology/epp/downloads/release/oxygen/R/eclipse-cpp-oxygen-R-linux-gtk-x86_64.tar.gz</li>
                </ul>
              </li>
            </ul>
          </li>
          <li>Extract tools<br>
            <ul>
              <li>tar xjf gcc-arm-none-eabi-6-2017-q2-update-linux.tar.bz2</li>
              <li>tar xzf gnuarmeclipse-openocd-debian64-0.10.0-201704182147-dev.tgz</li>
            </ul>
          </li>
          <li>Add extracted tool binaries to PATH environment variable<br>
            <ul>
              <li>/bin/echo 'export PATH="/tmp/gcc-arm-none-eabi-6-2017-q2-update/bin:/tmp/gnuarmeclipse/openocd/0.10.0-201704182147-dev/bin:$PATH"' >> ~/.bashrc</li>
              <li>source ~/.bashrc</li>
            </ul>
          </li>
          <li>Setup udev rules to make the USB devices available to non-root users<br>
            <ul>
              <li>/bin/echo -e '# 0483:df11 STMicroelectronics STM Device in DFU Mode' > /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'SUBSYSTEM=="usb", ATTR{idVendor}=="0483", ATTR{idProduct}=="df11", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e '# 0483:3748 STMicroelectronics ST-LINK/V2' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'SUBSYSTEM=="usb", ATTR{idVendor}=="0483", ATTR{idProduct}=="3748", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e '# 0483:374b STMicroelectronics ST-LINK/V2.1 (Nucleo-F103RB)' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'SUBSYSTEM=="usb", ATTR{idVendor}=="0483", ATTR{idProduct}=="374b", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e '# 534c:0001 SatoshiLabs Bitcoin Wallet [TREZOR]' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'SUBSYSTEM=="usb", ATTR{idVendor}=="534c", ATTR{idProduct}=="0001", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'KERNEL=="hidraw*", ATTRS{idVendor}=="534c", ATTRS{idProduct}=="0001", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e '# 1209:53c0 SatoshiLabs TREZOR v2 Bootloader' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'SUBSYSTEM=="usb", ATTR{idVendor}=="1209", ATTR{idProduct}=="53c0", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'KERNEL=="hidraw*", ATTRS{idVendor}=="1209", ATTRS{idProduct}=="53c0", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e '# 1209:53c1 SatoshiLabs TREZOR v2' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'SUBSYSTEM=="usb", ATTR{idVendor}=="1209", ATTR{idProduct}=="53c1", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>/bin/echo -e 'KERNEL=="hidraw*", ATTRS{idVendor}=="1209", ATTRS{idProduct}=="53c1", MODE="0666"' >> /tmp/99-dev-kit.rules</li>
              <li>sudo cp /tmp/99-dev-kit.rules /etc/udev/rules.d/</li>
            </ul>
          </li>
          <li>Download, build, and package the TREZOR v1 bootloader and firmware from source code<br>
              Note: The "export MEMORY_PROTECT=0" is what controls the code that locks the bootloader's flash memory on your dev board.<br>
              Warning: If you compile with MEMORY_PROTECT=1 (the default if not set as directed below), and run it on your dev board, you will lock your MCU's bootloader flash memory sectors and permanently disable debug capabilities.<br>
            <ul>
              <li>git clone https://github.com/trezor/trezor-mcu.git</li>
              <li>cd trezor-mcu/</li>
              <li>git submodule update --init --recursive</li>
              <li>make -C vendor/libopencm3/</li>
              <li>make -C vendor/nanopb/generator/proto/</li>
              <li>make -C firmware/protob/</li>
              <li>export MEMORY_PROTECT=0</li>
              <li>make</li>
              <li>make -C bootloader/ align</li>
              <li>make -C firmware/ sign</li>
              <li>cp bootloader/bootloader.bin bootloader/combine/bl.bin</li>
              <li>cp firmware/trezor.bin bootloader/combine/fw.bin</li>
              <li>cd bootloader/combine/ && ./prepare.py</li>
            </ul>
          </li>
          <li>Plug both the dev board and the debug adapter into your computer's USB ports.</li>
          <li>openocd -f interface/stlink-v2.cfg -f target/stm32f4x.cfg</li>
          <li>Open another terminal, then connect gdb to the OpenOCD process that was started in the previous step, and send OpenOCD the flash command to write the combined bootloader and firmware binary to MCU flash memory:<br>
              arm-none-eabi-gdb --nx -ex 'set remotetimeout unlimited' -ex 'set confirm off' -ex 'target remote 127.0.0.1:3333' -ex 'monitor reset halt' -ex 'monitor flash write_image erase /tmp/trezor-mcu/bootloader/combine/combined.bin 0x08000000' -ex 'monitor reset halt' /tmp/trezor-mcu/bootloader/bootloader.elf
          </li>
          <li>Flash has now been written. Set some test breakpoints and practice debugging code:<br>
            <ul>
              <li>(gdb) b *reset_handler</li>
              <li>(gdb) b *memory_protect</li>
              <li>(gdb) b *load_app</li>
              <li>(gdb) layout regs</li>
              <li>(gdb) si</li>
              <li>(gdb) c</li>
              <li>(gdb) c</li>
              <li>(gdb) d</li>
              <li>(gdb) file ../../firmware/trezor.elf</li>
              <li>(gdb) b *main</li>
              <li>(gdb) c</li>
              <li>(gdb) c</li>
              <li>(gdb) Press Ctrl + C to interrupt software execution</li>
              <li>(gdb) quit</li>
            </ul>
            <p>Note that the symbol files were changed above at a point in the debugging process near bootloader-exit/firmware-entry. This was done in order to add breakpoints based on symbols relevant to the code being executed.</p>
            <p>Also, be sure to check the display module and progress past the unofficial firmware warning message by pressing the appropriate buttons. Otherwise, it will seem as though your debugging session has simply stopped working. In fact, the code is just waiting for your user input.</p>
          </li>
          <li>Done flashing the software to the dev board and debugging. Kill the OpenOCD process and unplug the debug adapter and dev board.</li>
          <li>Test the bootloader and firmware just loaded onto the dev board:<br>
            <ul>
              <li>Plug-in the dev board and progress past the unofficial firmware warnings (if you are running the firmware that was compiled earlier and not an officially signed firmware).</li>
              <li>cd /tmp/</li>
              <li>git clone https://github.com/trezor/python-trezor.git</li>
              <li>./python-trezor/trezorctl wipe_device</li>
              <li>./python-trezor/trezorctl load_device -m 'fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun fun agent'</li>
              <li>./python-trezor/trezorctl get_address -c Bitcoin -n "Bitcoin/0'/0/0"</li>
              <li>./python-trezor/trezorctl get_address -c Litecoin -n "Litecoin/0'/0/0"</li>
              <li>./python-trezor/trezorctl get_address -c Namecoin -n "Namecoin/0'/0/0"</li>
            </ul>
          </li>
          <li>Install eclipse so that a graphical environment can be used for debugging:<br>
            <ul>
              <li>cd /tmp/</li>
              <li>tar xzf eclipse-cpp-oxygen-R-linux-gtk-x86_64.tar.gz</li>
              <li>mkdir -p /tmp/eclipse-workspace</li>
            </ul>
          </li>
          <li>Start OpenOCD and eclipse. Setup a debug configuration and debug graphically.<br>
              The full process to setup graphical debugging is shown in the video in Figure S1.<br>
            <figure>
              <video controls><source src="./videos/eclipse-debug.webm" type="video/webm"></video>
             <figcaption>Fig S1. - Eclipse Graphical Debugging Demonstration Video</figcaption>
            </figure>
          </li>
        </ol>
      </section>
    </section>
    <section>
      <h1>Going Further</h1>
      <section>
        <h1>Loading and Running an Officially Signed Firmware</h1>
        <p>In the setup process, a self-built bootloader and firmware was compiled, combined, and then loaded onto the MCU flash. To use an officially signed firmware, simply replace fw.bin in the setup process above before running prepare.py. Then run the prepare.py and load the newly created combined.bin onto the MCU.</p>
        <p>
          An officially signed firmware can be downloaded with:<br>
          wget -O fw.bin https://wallet.trezor.io/data/firmware/trezor-1.5.2.bin
        </p>
      </section>
      <section>
        <h1>Running Standalone</h1>
        <p>These kits can be used in a standalone configuration; without the debug adapter connected. Simply unplug and/or detach the debug adapter from the dev board and plug the dev board into your computer's USB port.</p>
        <figure>
          <a href="./images/kit-running-no-debug-adapter.jpg" target="_blank"><img src="./images/kit-running-no-debug-adapter.jpg" alt="The v0 Kit Running Standalone without Debug Adapter Connected"></a>
          <figcaption>Fig O1. - The v0 Kit Running Standalone without Debug Adapter Connected</figcaption>
        </figure>
      </section>
      <section>
        <h1>Flashing in DFU mode with dfu-util instead of flashing with OpenOCD</h1>
        <p>
          The setup process used OpenOCD to flash code into the MCU's flash memory and was done in non-Device Firmware Upgrade (DFU) mode.
          DFU mode can be used instead. Doing so just requires using different tools, moving a switch, and unplugging and replugging the dev board a couple of times.
          Using DFU mode is a little less convenient when compared to the flash process used above.
        </p>
        <p>
          To use DFU mode<br>
          <ul>
            <li>Unplug the dev board and debug adapter if either is plugged into your computer's USB port(s)</li>
            <li>Flip the Boot Config switch to System/DFU mode (Number 2 in Figure H29 above)</li>
            <li>Plug the dev board into your computer's USB port</li>
            <li>Verify with:<br>
            lsusb | grep 'STMicroelectronics STM Device in DFU Mode'<br>
            You'll see something like:<br>
            0483:df11 STMicroelectronics STM Device in DFU Mode
            </li>
            <li>cd /tmp/</li>
            <li>sudo apt-get -y install dfu-util</li>
            <li>dfu-util -a 0 -s 0x8000000 -D /tmp/trezor-mcu/bootloader/combine/combined.bin</li>
            <li>Wait until finished and then unplug the dev board</li>
            <li>Flip the Boot Config switch back to Flash mode (Number 2 in Figure H29 above)</li>
            <li>Plug the dev board into your computer's USB port. You're now running the code that you just stored into the MCU's flash memory.</li>
          </ul>
        </p>
      </section>
      <section>
        <h1>Getting Info About and Erasing MCU Flash</h1>
        <ul>
          <li>Retrieve info about current state of the flash memory sectors<br>
          (gdb) monitor flash info 0
          </li>
          <li>Erase all flash memory sectors<br>
          (gdb) monitor flash erase_sector 0 0 last
          </li>
        </ul>
      </section>
      <section>
        <h1>Compiling and Using the Latest Version of OpenOCD</h1>
        <ul>
          <li>Reference: https://sourceforge.net/p/openocd/code/ci/master/tree/README</li>
          <li>git clone git://git.code.sf.net/p/openocd/code.git openocd</li>
          <li>sudo apt-get -y install libtool autoconf automake texinfo libusb-0.1-4 libusb-1.0-0</li>
          <li>cd openocd/</li>
          <li>./bootstrap</li>
          <li>./configure</li>
          <li>make</li>
          <li>sudo make install</li>
          <li>openocd -f interface/stlink-v2.cfg -f target/stm32f4x.cfg</li>
        </ul>
      </section>
      <section>
        <h1>Questions</h1>
        <ul>
          <li>Q: How can I verify that the code I built will not lock the bootloader flash memory sectors?<br>
              A: Before flashing the code, you can check with: arm-none-eabi-objdump -d /tmp/trezor-mcu/bootloader/bootloader.elf | less<br>
                 You can use that to search for the memory_protect function to make sure that the generated code does not perform the steps to enable memory protection.
          </li>
          <li>Q: How can I build a specific version of the firmware?<br>
              A: Checkout the firmware's tag to a new branch and update the submodules. For example, to work on the version 1.5.2 firmware:<br>
              <ul>
                <li>git checkout -b example tags/v1.5.2</li>
                <li>git submodule update</li>
              </ul>
          </li>
          <li>Q: How can I use the debugger to find all occurences of a string in memory?<br>
              A: find 0x20000000,0x2001ffff,"123456789"
          </li>
          <li>Q: How can I use the debugger to watch a specific string in memory?<br>
              A: display /s (char *) 0x20001000
          </li>
          <li>Q: How can I veriy that the udev rules applied correctly to my USB device?<br>
              A: To verify, for example, that your dev kit (running TREZOR firmware) configured properly:<br>
                 > lsusb | grep '534c:0001'<br>
                 Bus 002 Device 007: ID 534c:0001 SatoshiLabs Bitcoin Wallet [TREZOR]<br>
                 > ls -al /dev/bus/usb/002/007<br>
                 crw-rw-rw- 1 root root ...<br>
                 If the last line of your output matches the line above, then the udev rules are working.<br>
          </li>
          <li>Q: How can I disassemble a binary ".bin" file?<br>
              A: arm-none-eabi-objdump -b binary -D -marm -M force-thumb trezor-1.5.2.bin
          </li>
          <li>Q: How can I write to a specific memory location while debugging?<br>
              A: set *(unsigned int *)0x20010000 = 0x11223344
          </li>
        </ul>
      </section>
      <section>
        <h1>More Open Source TREZOR Related Work</h1>
        <ul>
          <li><a target="_blank" href="http://www.stellaw.info/blog/2015/12/22/i-built-my-own-trezor-clone-dinosaur-hiphop-zero">I built my own Trezor clone: DINOSAUR HIPHOP ZERO</a></li>
          <li><a target="_blank" href="http://www.stellaw.info/blog/2016/3/5/dinosaur-hiphop-zero-alphaprototype-dev-kits-for-sale">DINOSAUR HIPHOP ZERO alpha/prototype dev kits for sale</a></li>
          <li><a target="_blank" href="http://www.stellaw.info/blog/2015/12/16/breakout-board">Breakout Board</a></li>
          <li><a target="_blank" href="http://dinosaur.hiphop/">http://dinosaur.hiphop/</a></li>
          <li><a target="_blank" href="https://github.com/karek314/trezor-diy-development-board">Trezor DIY Development Board</a></li>
          <li><a target="_blank" href="https://github.com/cryptotronix/breakingbitcoin-hw">DEF CON 25 - Breaking Bitcoin Hardware</a></li>
          <li><a target="_blank" href="https://youtu.be/BzxGoJdd8a4">EEVblog #1006 - Trezor Bitcoin Hardware Wallet Teardown</a></li>
          <li><a target="_blank" href="https://en.bitcoin.it/wiki/Hardware_wallet">Bitcoin Hardware Wallet Wiki</a></li>
          <li><a target="_blank" href="http://saleemrashid.com/2017/08/17/extracting-trezor-secrets-sram/">Saleem Rashid - Extracting TREZOR secrets from SRAM</a></li>
          <li><a target="_blank" href="https://www.usenix.org/system/files/conference/woot17/woot17-paper-obermaier.pdf">Research Paper: Shedding too much Light on a Microcontroller's Firmware Protection</a></li>
        </ul>
      </section>
    </section>
  </body>
</html>

